import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

// å®šä¹‰è·¯å¾„
const iconsDir = path.resolve(__dirname, '../src/assets/icons')
const outputFile = path.resolve(__dirname, '../src/components/ui/icons.ts')

// è¯»å–æ‰€æœ‰SVGæ–‡ä»¶
function generateIconsFile() {
  try {
    // è¯»å–iconsç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
    const files = fs.readdirSync(iconsDir)
    const svgFiles = files.filter(file => file.endsWith('.svg'))
    
    if (svgFiles.length === 0) {
      console.log('No SVG files found in icons directory')
      return
    }
    
    // ç”ŸæˆTypeScriptå†…å®¹
    let tsContent = '// Auto-generated file - Do not edit manually\n'
    tsContent += '// Generated by scripts/generate-icons.js\n\n'
    
    // å®šä¹‰å›¾æ ‡æ¥å£
    tsContent += 'export interface IconData {\n'
    tsContent += '  name: string\n'
    tsContent += '  content: string\n'
    tsContent += '}\n\n'
    
    // ç”Ÿæˆå›¾æ ‡æ•°æ®
    const iconData = []
    
    svgFiles.forEach(file => {
      const iconName = path.basename(file, '.svg')
      const filePath = path.join(iconsDir, file)
      const svgContent = fs.readFileSync(filePath, 'utf-8')
      
      // æ¸…ç†SVGå†…å®¹ï¼Œç§»é™¤ä¸å¿…è¦çš„å±æ€§
      const cleanedSvg = svgContent
        .replace(/width="[^"]*"/g, '')
        .replace(/height="[^"]*"/g, '')
        .replace(/style="[^"]*"/g, '')
        .replace(/<svg/, '<svg width="100%" height="100%"')
        .replace(/\s+/g, ' ')
        .trim()
      
      iconData.push({
        name: iconName,
        content: cleanedSvg
      })
    })
    
    // ç”Ÿæˆå›¾æ ‡å¸¸é‡
    tsContent += 'export const ICONS: Record<string, string> = {\n'
    iconData.forEach(icon => {
      tsContent += `  '${icon.name}': \`${icon.content}\`,\n`
    })
    tsContent += '}\n\n'
    
    // ç”Ÿæˆå›¾æ ‡åç§°ç±»å‹
    tsContent += 'export type IconName = \n'
    const iconNames = iconData.map(icon => `  | '${icon.name}'`).join('\n')
    tsContent += iconNames + '\n\n'
    
    // ç”Ÿæˆè·å–å›¾æ ‡çš„å‡½æ•°
    tsContent += 'export function getIcon(name: IconName): string | undefined {\n'
    tsContent += '  return ICONS[name]\n'
    tsContent += '}\n\n'
    
    // ç”Ÿæˆè·å–æ‰€æœ‰å›¾æ ‡åç§°çš„å‡½æ•°
    tsContent += 'export function getAllIconNames(): IconName[] {\n'
    tsContent += '  return Object.keys(ICONS) as IconName[]\n'
    tsContent += '}\n'
    
    // ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    const outputDir = path.dirname(outputFile)
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true })
    }
    
    // å†™å…¥æ–‡ä»¶
    fs.writeFileSync(outputFile, tsContent, 'utf-8')
    
    console.log(`âœ… Generated icons.ts with ${iconData.length} icons`)
    console.log(`ğŸ“ Output: ${outputFile}`)
    
    // æ‰“å°ç”Ÿæˆçš„å›¾æ ‡åˆ—è¡¨
    console.log('\nğŸ“‹ Generated icons:')
    iconData.forEach(icon => {
      console.log(`   - ${icon.name}`)
    })
    
  } catch (error) {
    console.error('âŒ Error generating icons file:', error)
    process.exit(1)
  }
}

// æ‰§è¡Œç”Ÿæˆ
generateIconsFile()